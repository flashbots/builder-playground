base: buildernet
description: Deploy the stack with the BuilderNet mkosi image (QEMU)

recipe:
  builder-vm:
    services:
      attested-tls-proxy:
        image: ghcr.io/flashbots/attested-tls-proxy
        tag: "1.0.1"
        args:
          - server
          - --listen-addr
          - 0.0.0.0:7000
          - --server-attestation-type
          - none
          - --allowed-remote-attestation-type
          - none
          - --tls-private-key-path
          - /server.key
          - --tls-certificate-path
          - /server.crt
          - builder-hub-proxy:8888
        ports:
          http: 7000
        depends_on:
          - builder-hub-proxy:healthy
        files:
          "/server.key": "config/server.key"
          "/server.crt": "config/server.crt"

      builder:
        lifecycle_hooks: true
        init:
          - rm -rf .runtime/buildernet-vm.qcow2 || true
          - ./scripts/prepare.sh
        start: ./scripts/start.sh
        stop:
          - ./scripts/stop.sh
